# Userflow - AI 사주 분석 구독 서비스

## 개요

본 문서는 AI 기반 구독제 사주 분석 서비스의 주요 사용자 플로우를 정의합니다. 각 플로우는 입력, 처리, 출력 단계로 구성되며, 엣지케이스 및 예외 상황에 대한 대응을 포함합니다.

---

## 1. 신규 회원가입 및 첫 분석 플로우

### 1.1 정상 플로우

#### 1.1.1 입력
- 사용자가 홈 페이지 접속
- CTA 버튼 클릭
- Google 로그인 선택
- Google 계정 인증 완료

#### 1.1.2 처리
1. Clerk가 Google OAuth 인증 처리
2. 인증 성공 시 Clerk webhook 발생
3. 백엔드가 webhook 수신 및 검증
4. Supabase users 테이블에 신규 사용자 레코드 생성
   - clerk_user_id, email 저장
   - subscription_tier: 'free' 설정
5. usage_records 테이블에 초기 레코드 생성
   - count: 0, limit: 1
6. 세션 토큰 발급 및 쿠키 설정

#### 1.1.3 출력
- 대시보드 페이지로 자동 리다이렉트
- 환영 메시지 표시
- 구독 상태 배지 표시 (무료 체험)
- 남은 분석 횟수 표시 (0/1회 사용)
- 새 분석하기 버튼 활성화 상태

---

### 1.2 첫 분석 수행 플로우

#### 1.2.1 입력
- 새 분석하기 버튼 클릭
- 생년월일 입력 (DatePicker)
- 출생 시간 입력 (TimePicker 또는 모름 선택)
- 양력/음력 선택
- 성별 선택
- 분석하기 버튼 클릭

#### 1.2.2 처리
1. 프론트엔드 폼 검증
   - 필수 필드 입력 확인 (생년월일, 양력/음력, 성별)
   - 날짜 유효성 검증 (미래 날짜 불가)
2. API 요청 전송
3. 백엔드 검증
   - 인증 토큰 확인
   - 사용자 구독 상태 확인
   - 사용 가능 횟수 확인 (트랜잭션 시작)
4. 사용량 체크
   - usage_records에서 현재 월 레코드 조회
   - 남은 횟수 확인 (무료: 1회)
5. Gemini API 호출
   - 모델 선택: gemini-2.5-flash (무료 유저)
   - 구조화된 프롬프트 생성 (생년월일시, 양력/음력, 성별 포함)
   - API 호출 (최대 3회 재시도)
6. 분석 결과 생성 및 저장
   - analyses 테이블에 분석 결과 저장
   - result 필드에 JSONB 형태로 전체 분석 저장
   - model_used: 'gemini-2.5-flash'
7. 사용량 차감
   - usage_records 업데이트 (count: 1)
   - 트랜잭션 커밋

#### 1.2.3 출력
- 분석 진행 중 로딩 상태 표시
  - 스피너 애니메이션
  - 메시지 표시
- 분석 완료 시 분석 상세보기 페이지로 자동 이동
- 분석 결과 렌더링
  - 분석 정보 헤더
  - 사주팔자 기본 구성
  - 성격 및 기질
  - 대운·세운 분석
  - 운세 종합
  - 조언 및 제안
- 액션 버튼 표시 (대시보드로 돌아가기)

---

### 1.3 엣지케이스 및 예외 처리

#### 1.3.1 Google 로그인 실패
**입력**
- Google 인증 중 사용자가 취소 또는 권한 거부

**처리**
- Clerk가 인증 실패 이벤트 감지

**출력**
- 로그인 페이지로 리다이렉트
- 에러 메시지 표시
- 재시도 옵션 제공

#### 1.3.2 Webhook 처리 실패
**입력**
- Clerk webhook 전송 실패 또는 네트워크 오류

**처리**
- Webhook 재시도 메커니즘 (Clerk 자동)
- 백엔드 로깅

**출력**
- 사용자에게는 영향 없음 (Clerk 세션은 정상 동작)
- 관리자 알림 (사용자 데이터 동기화 실패)

#### 1.3.3 유효하지 않은 날짜 입력
**입력**
- 미래 날짜 입력
- 1900년 이전 날짜 입력
- 존재하지 않는 날짜 (예: 2월 30일)

**처리**
- 프론트엔드 폼 검증 단계에서 차단

**출력**
- 인라인 에러 메시지 표시
- 해당 필드에 포커스
- 제출 버튼 비활성화 유지

#### 1.3.4 Gemini API 호출 실패
**입력**
- API 타임아웃
- API 할당량 초과
- 네트워크 오류

**처리**
1. 첫 번째 재시도 (1초 대기)
2. 두 번째 재시도 (2초 대기)
3. 세 번째 재시도 (3초 대기)
4. 모두 실패 시 에러 처리
   - 사용량 차감 롤백 (트랜잭션)
   - 에러 로깅

**출력**
- 사용자에게 에러 메시지 표시
- 재시도 안내
- 고객 지원 연락처 제공
- 분석 입력 페이지로 복귀 (입력값 보존)

#### 1.3.5 동시 요청으로 인한 초과 사용
**입력**
- 사용자가 빠르게 여러 번 분석 요청

**처리**
- 데이터베이스 트랜잭션 사용
- 낙관적 잠금 (optimistic locking)
- 사용량 체크 시 FOR UPDATE 쿼리

**출력**
- 첫 번째 요청만 처리
- 이후 요청은 사용 횟수 부족 에러 반환
- 에러 메시지 표시

#### 1.3.6 분석 결과 저장 실패
**입력**
- 데이터베이스 연결 오류
- 디스크 용량 부족

**처리**
- 트랜잭션 롤백
- 사용량 차감 취소
- 에러 로깅 및 알림

**출력**
- 사용자에게 에러 메시지 표시
- 재시도 안내
- 사용 횟수는 차감되지 않음 확인 메시지

---

## 2. Pro 구독 결제 플로우

### 2.1 정상 플로우

#### 2.1.1 입력
- 대시보드에서 Pro 업그레이드 버튼 클릭 또는
- 구독 관리 페이지에서 Pro 구독하기 버튼 클릭
- 토스페이먼츠 결제창 노출
- 카드 정보 입력 (카드번호, 유효기간, 비밀번호 앞 2자리, 생년월일/사업자번호)
- 결제 동의 체크
- 결제하기 버튼 클릭

#### 2.1.2 처리
1. 토스페이먼츠 SDK 초기화
   - 클라이언트 키 사용
   - 구독 결제 모드 설정
2. 빌링키 발급 요청
   - 고객 정보 전송 (이메일, 이름)
   - 카드사 인증 진행
3. 토스페이먼츠 콜백 수신 (성공 시)
   - authKey 전달받음
4. 백엔드 API 호출
   - authKey를 서버로 전송
5. 서버에서 빌링키 발급 완료
   - 토스페이먼츠 API 호출 (시크릿 키 사용)
   - billingKey 및 customerKey 수신
6. 첫 결제 승인 처리
   - 금액: 3,900원
   - 주문명: Pro 구독 (월 3,900원)
   - orderId 생성 (고유값)
7. 데이터베이스 업데이트 (트랜잭션)
   - users 테이블
     - subscription_tier: 'pro'
     - billing_key, customer_key 저장
   - subscriptions 테이블에 신규 레코드 생성
     - plan: 'pro'
     - status: 'active'
     - started_at: 현재 시각
     - next_billing_date: 현재 시각 + 1개월
   - payment_history 테이블에 결제 기록 추가
   - usage_records 업데이트
     - limit: 10으로 변경
     - count: 0으로 초기화 (새로운 월 시작)
8. Webhook 설정 (토스페이먼츠)
   - 정기결제 상태 변경 이벤트 구독

#### 2.1.3 출력
- 결제 진행 중 로딩 표시
- 결제 성공 시 성공 페이지 또는 모달 표시
  - 축하 메시지
  - Pro 혜택 안내
  - 다음 결제일 표시
- 대시보드로 자동 리다이렉트
- 구독 상태 배지 업데이트 (Pro 구독 중)
- 남은 분석 횟수 업데이트 (0/10회)
- Pro 업그레이드 버튼 숨김

---

### 2.2 엣지케이스 및 예외 처리

#### 2.2.1 카드 인증 실패
**입력**
- 잘못된 카드 정보
- 한도 초과 카드
- 정지된 카드

**처리**
- 토스페이먼츠가 에러 코드 반환
- 백엔드가 에러 로깅

**출력**
- 결제 실패 페이지로 리다이렉트
- 에러 메시지 표시 (카드사 응답 메시지)
- 재시도 버튼 제공
- 다른 결제 수단 시도 안내

#### 2.2.2 빌링키 발급 실패
**입력**
- 토스페이먼츠 API 오류
- 네트워크 타임아웃

**처리**
- 백엔드에서 에러 감지
- 재시도 로직 (최대 3회)
- 모두 실패 시 에러 로깅

**출력**
- 결제 실패 페이지로 리다이렉트
- 에러 메시지 표시
- 고객 지원 연락처 제공
- 데이터베이스는 변경되지 않음

#### 2.2.3 첫 결제 승인 실패
**입력**
- 빌링키 발급은 성공했으나 첫 결제 승인 실패

**처리**
- 백엔드에서 빌링키 삭제 요청
- 트랜잭션 롤백
- 에러 로깅

**출력**
- 결제 실패 페이지
- 에러 메시지 표시
- 재시도 안내
- Pro 구독 미활성화 유지

#### 2.2.4 사용자가 결제창 닫기
**입력**
- 결제창에서 취소 버튼 클릭
- 브라우저 닫기

**처리**
- 토스페이먼츠가 취소 이벤트 발생
- 백엔드 호출 없음

**출력**
- 구독 관리 페이지로 복귀
- 안내 메시지 표시 (결제가 취소되었습니다)
- Pro 구독하기 버튼 다시 표시

#### 2.2.5 이미 Pro 구독 중인 사용자가 재구독 시도
**입력**
- Pro 구독 중인 사용자가 Pro 구독하기 버튼 클릭 (UI에서는 숨김 처리되어야 하나 직접 API 호출 시)

**처리**
- 백엔드에서 구독 상태 확인
- 이미 활성 구독 존재 시 에러 반환

**출력**
- 에러 메시지 표시 (이미 Pro 구독 중입니다)
- 구독 관리 페이지로 리다이렉트

#### 2.2.6 Webhook 처리 지연
**입력**
- 토스페이먼츠 webhook 전송 지연
- 네트워크 오류로 webhook 미수신

**처리**
- 토스페이먼츠 자동 재시도 (최대 10회)
- 백엔드에서 멱등성 보장 (동일 orderId 중복 처리 방지)

**출력**
- 사용자에게는 정상 결제 완료로 보임
- 백엔드에서 비동기 처리 (webhook 수신 시 데이터 정합성 확인)

---

## 3. 사주 분석 요청 플로우 (Pro 유저)

### 3.1 정상 플로우

#### 3.1.1 입력
- 대시보드에서 새 분석하기 버튼 클릭
- 생년월일시 입력
- 양력/음력, 성별 선택
- 분석하기 버튼 클릭

#### 3.1.2 처리
1. 프론트엔드 폼 검증
2. 백엔드 API 호출
3. 인증 및 구독 상태 확인
   - Pro 구독 활성 상태 확인
4. 사용량 체크 (트랜잭션)
   - 현재 월 사용량 조회
   - 남은 횟수 확인 (10회 제한)
5. Gemini API 호출
   - 모델 선택: gemini-2.5-pro (Pro 유저)
   - 프롬프트 생성 및 API 호출
6. 분석 결과 저장
   - analyses 테이블에 저장
   - model_used: 'gemini-2.5-pro'
7. 사용량 차감
   - usage_records 업데이트
   - 트랜잭션 커밋

#### 3.1.3 출력
- 로딩 상태 표시
- 분석 상세보기 페이지로 이동
- Pro 모델 사용 안내 표시 (선택사항)
- 분석 결과 렌더링

---

### 3.2 엣지케이스 및 예외 처리

#### 3.2.1 사용 횟수 초과 (10회 모두 사용)
**입력**
- 이미 10회 분석 완료한 Pro 유저가 추가 분석 시도

**처리**
- 백엔드에서 사용량 확인
- 남은 횟수 0회 감지

**출력**
- 에러 메시지 표시
  - 이번 달 분석 횟수를 모두 사용하였습니다
  - 다음 초기화 날짜 표시
- 분석 입력 폼 비활성화
- 대시보드로 복귀 안내

#### 3.2.2 구독 취소 예정 상태에서 분석 시도
**입력**
- 구독 취소했으나 만료일 전인 Pro 유저가 분석 시도

**처리**
- 백엔드에서 구독 상태 확인
- status: 'canceled'이나 next_billing_date가 미래인 경우 허용

**출력**
- 정상적으로 분석 처리
- 안내 메시지 표시 (구독 만료일까지 혜택 유지)

#### 3.2.3 구독 만료 후 분석 시도
**입력**
- 구독이 완전히 만료된 사용자가 분석 시도

**처리**
- 백엔드에서 구독 상태 확인
- status: 'expired' 또는 next_billing_date 초과 감지
- users 테이블 subscription_tier를 'free'로 업데이트
- usage_records를 무료 플랜으로 초기화 (limit: 1)

**출력**
- 에러 메시지 표시 (Pro 구독이 만료되었습니다)
- Pro 재구독 안내 및 버튼 표시
- 무료 플랜으로 전환되었음 안내

#### 3.2.4 월 초기화 시점 경계 케이스
**입력**
- 다음 결제일이 오늘인 상태에서 분석 시도

**처리**
- 백엔드에서 next_billing_date 확인
- 오늘 날짜가 next_billing_date 이상인 경우
  1. 정기결제 자동 처리 트리거 확인
  2. usage_records 초기화 (count: 0)
  3. subscriptions 테이블 next_billing_date 업데이트 (+1개월)

**출력**
- 사용량이 초기화되었습니다 안내 메시지 표시
- 정상적으로 분석 진행 (새로운 월 첫 분석)

#### 3.2.5 Gemini API 할당량 초과
**입력**
- Gemini API의 일일 할당량 초과

**처리**
- Gemini API가 429 에러 반환
- 백엔드에서 에러 감지
- 사용량 차감 롤백

**출력**
- 에러 메시지 표시 (일시적인 서비스 장애)
- 잠시 후 재시도 안내
- 고객 지원 연락처 제공
- 관리자에게 알림 발송

---

## 4. 분석 이력 조회 플로우

### 4.1 정상 플로우

#### 4.1.1 입력
- 대시보드 접속
- 분석 이력 목록 표시 영역 스크롤
- 특정 분석 항목의 자세히 보기 버튼 클릭

#### 4.1.2 처리
1. 백엔드 API 호출
   - 사용자 ID로 analyses 테이블 조회
   - 최신순 정렬 (created_at DESC)
   - 페이지네이션 적용 (예: 10개씩)
2. 본인 소유 확인
   - 요청한 분석의 user_id와 현재 로그인 사용자 ID 비교
3. 분석 데이터 반환

#### 4.1.3 출력
- 대시보드에 분석 이력 목록 렌더링
  - 분석 날짜 및 시간
  - 생년월일 (일부 마스킹)
  - 간단한 미리보기 텍스트
- 자세히 보기 클릭 시 분석 상세보기 페이지로 이동
- 분석 결과 전체 표시

---

### 4.2 엣지케이스 및 예외 처리

#### 4.2.1 분석 이력 없음
**입력**
- 신규 가입 사용자가 대시보드 접속

**처리**
- 백엔드에서 빈 배열 반환

**출력**
- 안내 메시지 표시 (아직 분석 이력이 없습니다)
- 새 분석하기 버튼 강조
- 첫 분석 유도 메시지

#### 4.2.2 타인의 분석 조회 시도
**입력**
- URL 직접 입력으로 다른 사용자의 분석 ID 접근

**처리**
- 백엔드에서 user_id 확인
- 불일치 시 403 에러 반환

**출력**
- 에러 페이지 표시 (접근 권한 없음)
- 대시보드로 복귀 버튼

#### 4.2.3 존재하지 않는 분석 ID
**입력**
- 잘못된 또는 삭제된 분석 ID로 접근

**처리**
- 백엔드에서 404 에러 반환

**출력**
- 에러 페이지 표시 (분석을 찾을 수 없습니다)
- 대시보드로 복귀 버튼

#### 4.2.4 페이지네이션 경계
**입력**
- 마지막 페이지에서 다음 페이지 요청

**처리**
- 백엔드에서 빈 배열 반환

**출력**
- 더 이상 불러올 분석이 없습니다 메시지 표시
- 다음 페이지 버튼 비활성화

#### 4.2.5 분석 데이터 손상
**입력**
- 분석 결과의 JSONB 데이터가 손상된 경우

**처리**
- 백엔드에서 JSON 파싱 에러 감지
- 에러 로깅

**출력**
- 에러 메시지 표시 (분석 결과를 불러올 수 없습니다)
- 고객 지원 연락처 제공
- 관리자에게 알림 발송

---

## 5. 구독 관리 플로우

### 5.1 구독 취소 플로우

#### 5.1.1 입력
- 구독 관리 페이지 접속
- 구독 취소 버튼 클릭
- 확인 모달에서 취소 사유 선택 (선택사항)
- 확인 버튼 클릭

#### 5.1.2 처리
1. 백엔드 API 호출
2. 구독 상태 확인
   - 현재 status: 'active' 확인
3. subscriptions 테이블 업데이트
   - status: 'canceled'
   - canceled_at: 현재 시각
   - next_billing_date 유지 (만료일까지 혜택 유지)
4. 토스페이먼츠 빌링키 삭제 요청
   - 다음 결제일 이후로 예약 (즉시 삭제하지 않음)
5. 취소 사유 로깅 (분석용)

#### 5.1.3 출력
- 구독 취소 완료 모달 표시
  - 만료일까지 Pro 혜택 유지 안내
  - 만료일 명시
  - 재개 가능 안내
- 구독 관리 페이지 상태 업데이트
  - Pro (취소 예정) 배지 표시
  - 구독 재개 버튼 표시
  - 구독 취소 버튼 숨김

---

### 5.2 구독 재개 플로우

#### 5.2.1 입력
- 구독 관리 페이지 (취소 예정 상태)
- 구독 재개 버튼 클릭
- 확인 모달에서 확인 버튼 클릭

#### 5.2.2 처리
1. 백엔드 API 호출
2. 구독 상태 확인
   - status: 'canceled' 확인
   - next_billing_date가 미래인지 확인
3. subscriptions 테이블 업데이트
   - status: 'active'
   - canceled_at: NULL
4. 토스페이먼츠 빌링키 삭제 예약 취소
   - 기존 빌링키로 정기결제 재개

#### 5.2.3 출력
- 구독 재개 완료 모달 표시
  - 다음 결제일부터 정기결제 재시작 안내
- 구독 관리 페이지 상태 업데이트
  - Pro 구독 중 배지 표시
  - 구독 취소 버튼 표시
  - 구독 재개 버튼 숨김

---

### 5.3 엣지케이스 및 예외 처리

#### 5.3.1 이미 취소된 구독 재취소 시도
**입력**
- 취소 예정 상태에서 구독 취소 API 직접 호출

**처리**
- 백엔드에서 status 확인
- 이미 'canceled' 상태 감지

**출력**
- 에러 메시지 표시 (이미 취소된 구독입니다)
- 구독 관리 페이지로 리다이렉트

#### 5.3.2 만료된 구독 재개 시도
**입력**
- next_billing_date가 과거인 상태에서 재개 시도

**처리**
- 백엔드에서 만료 확인
- 빌링키 이미 삭제됨

**출력**
- 에러 메시지 표시 (만료된 구독은 재개할 수 없습니다)
- 새로운 Pro 구독하기 버튼 표시
- 새 빌링키 발급 안내

#### 5.3.3 빌링키 삭제 실패
**입력**
- 구독 취소 시 토스페이먼츠 API 오류

**처리**
- 재시도 로직 (최대 3회)
- 모두 실패 시 에러 로깅
- 데이터베이스는 취소 상태로 업데이트

**출력**
- 사용자에게는 정상 취소로 안내
- 백엔드에서 수동 처리 플래그 설정
- 관리자에게 알림 발송

#### 5.3.4 정기결제 실패 (자동)
**입력**
- 다음 결제일에 자동 결제 시도
- 카드 한도 초과, 정지 등으로 실패

**처리**
1. 토스페이먼츠가 webhook으로 결제 실패 이벤트 전송
2. 백엔드에서 재시도 로직
   - 1일 후 1차 재시도
   - 3일 후 2차 재시도
   - 7일 후 3차 재시도
3. 모두 실패 시
   - subscriptions 테이블 status: 'expired'
   - users 테이블 subscription_tier: 'free'
   - 빌링키 삭제
4. 사용자에게 이메일 알림 발송 (각 재시도 전/후)

**출력**
- 대시보드 접속 시 알림 배너 표시
  - 결제 실패 안내
  - 카드 정보 확인 요청
  - 재구독 버튼
- 구독 관리 페이지에 결제 실패 이력 표시

#### 5.3.5 결제 수단 변경 요청
**입력**
- 사용자가 카드 변경 요청

**처리**
1. 기존 빌링키 삭제
2. 새로운 카드로 빌링키 재발급
3. subscriptions 테이블 billing_key 업데이트

**출력**
- 토스페이먼츠 결제창 노출
- 새 카드 정보 입력
- 변경 완료 메시지
- 다음 결제일부터 새 카드로 결제 안내

#### 5.3.6 중복 Webhook 수신
**입력**
- 동일한 orderId의 webhook을 여러 번 수신

**처리**
- 백엔드에서 멱등성 보장
  - payment_history에서 orderId 존재 여부 확인
  - 이미 존재하면 중복 처리 스킵

**출력**
- 로그 기록 (중복 webhook 수신)
- 데이터 변경 없음

---

## 6. 공통 플로우 및 예외 처리

### 6.1 세션 만료

#### 6.1.1 입력
- 사용자가 오랜 시간 비활성 상태
- Clerk 세션 토큰 만료

#### 6.1.2 처리
- Clerk 미들웨어가 만료된 세션 감지
- 보호된 페이지 접근 차단

#### 6.1.3 출력
- 로그인 페이지로 자동 리다이렉트
- 안내 메시지 표시 (세션이 만료되었습니다. 다시 로그인해주세요)
- 로그인 후 원래 페이지로 복귀

---

### 6.2 네트워크 오류

#### 6.2.1 입력
- API 요청 중 네트워크 연결 끊김
- 타임아웃 발생

#### 6.2.2 처리
- 프론트엔드에서 에러 감지
- React Query 자동 재시도 (최대 3회)

#### 6.2.3 출력
- 로딩 상태 유지
- 재시도 중 메시지 표시
- 모두 실패 시 에러 메시지 표시
- 재시도 버튼 제공

---

### 6.3 서버 장애 (5xx)

#### 6.3.1 입력
- 백엔드 서버 오류
- 데이터베이스 연결 실패

#### 6.3.2 처리
- 백엔드 에러 핸들러가 500 에러 반환
- 에러 로깅 및 알림

#### 6.3.3 출력
- 에러 페이지 표시
- 일시적인 서비스 장애 안내
- 잠시 후 재시도 요청
- 고객 지원 연락처 제공

---

### 6.4 권한 없는 접근

#### 6.4.1 입력
- 비인증 사용자가 보호된 페이지 직접 URL 접근
- 타인의 리소스 접근 시도

#### 6.4.2 처리
- Clerk 미들웨어가 인증 상태 확인
- 백엔드에서 권한 확인

#### 6.4.3 출력
- 로그인 페이지로 리다이렉트 (비인증)
- 403 에러 페이지 표시 (권한 없음)

---

### 6.5 동시 세션 감지

#### 6.5.1 입력
- 동일 계정으로 여러 기기에서 로그인

#### 6.5.2 처리
- Clerk가 다중 세션 허용

#### 6.5.3 출력
- 정상적으로 동작
- 모든 기기에서 동일한 데이터 동기화

---

### 6.6 브라우저 호환성

#### 6.6.1 입력
- 지원하지 않는 구형 브라우저 접속

#### 6.6.2 처리
- 프론트엔드에서 브라우저 감지

#### 6.6.3 출력
- 안내 메시지 표시
- 권장 브라우저 목록 제공
- 제한적 기능 제공 (가능한 경우)

---

## 7. 플로우 다이어그램 요약

### 7.1 신규 사용자 전환 퍼널
```
홈 → 회원가입 → 대시보드 → 첫 분석 → 결과 확인 → Pro 업그레이드 → 정기 사용
```

### 7.2 분석 요청 핵심 플로우
```
입력 → 검증 → 사용량 체크 → AI 분석 → 저장 → 출력
```

### 7.3 결제 핵심 플로우
```
결제 시작 → 카드 입력 → 빌링키 발급 → 첫 결제 → DB 업데이트 → 완료
```

### 7.4 구독 관리 플로우
```
활성 ⇄ 취소 예정 → 만료 → 무료 전환
```

---

## 8. 참고 사항

### 8.1 데이터 일관성
- 모든 중요 작업은 트랜잭션으로 처리
- 사용량 차감은 API 성공 후에만 수행
- Webhook은 멱등성 보장

### 8.2 보안
- 모든 API는 인증 필수
- 본인 리소스만 접근 가능
- 결제 정보는 서버 사이드에서만 처리

### 8.3 사용자 경험
- 명확한 에러 메시지 제공
- 로딩 상태 표시
- 재시도 옵션 제공
- 중요 액션은 확인 모달 사용

### 8.4 모니터링
- 모든 에러는 로깅 및 알림
- 결제 실패는 즉시 알림
- API 성공률 모니터링
