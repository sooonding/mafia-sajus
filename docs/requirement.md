# Requirements - 구독제 사주 분석 서비스

## 만들 것

- 사주 분석 서비스 플랫폼

### 핵심 기능

1. **인증 시스템 (Clerk)**

   - Google 소셜 로그인
   - 회원가입 및 로그인 플로우
   - 사용자 세션 관리
   - 보호된 라우트 구현 (홈 제외 모든 페이지)

2. **결제 시스템 (토스페이먼츠)**

   - 구독 결제 연동 (월 3,900원)
   - 빌링키 발급 및 관리
   - 정기결제 처리
   - 구독 취소 및 재구독 기능
   - 결제 이력 조회

3. **사주 분석 시스템 (Gemini API)**

   - 생년월일시 입력 폼
   - Gemini 2.5 Flash (무료 유저용)
   - Gemini 2.5 Pro (Pro 구독자용)
   - 천간·지지·대운·세운 계산 및 해석
   - 분석 결과 생성 및 저장
   - 분석 이력 영구 보관

4. **사용량 관리 시스템**

   - 무료 유저: 1회 체험 제한
   - Pro 유저: 월 10회 제한 카운팅
   - 월별 사용량 초기화 로직
   - 사용 가능 횟수 표시

5. **데이터베이스 스키마**
   - 사용자 정보 (Clerk ID, 구독 상태, 생성일)
   - 구독 정보 (요금제, 시작일, 종료일, 취소 상태, 빌링키)
   - 분석 기록 (사용자 ID, 생년월일시, 분석 결과, 생성일) - **영구 보관**
   - 사용량 기록 (월별 카운트)

---

## 주의 사항

### 인증 (Clerk)

- Clerk의 기본 제공 컴포넌트 활용 (SignIn, SignUp, UserButton 등)
- 미인증 사용자가 보호된 페이지 접근 시 로그인 페이지로 리다이렉트
- 홈(랜딩) 페이지는 인증 없이 접근 가능
- Clerk Middleware를 통한 라우트 보호 설정 필수

### 결제 (토스페이먼츠)

- **가격 정책**
  - 무료: 1회 체험 제공
  - Pro 구독: 월 3,900원, 월 10회 분석
- **빌링키 관리**
  - 구독 해지 시 즉시 빌링키 삭제
  - 재구독 시 새로운 빌링키 발급 필요
- **구독 취소 정책**
  - 취소 시에도 다음 결제일까지 Pro 혜택 유지
  - 다음 결제일 전까지 취소 철회 가능
  - 취소 철회 시 기존 빌링키로 정기결제 재개
- **결제 실패 처리**
  - 결제 실패 시 재시도 로직 구현
  - 연속 실패 시 구독 자동 해지 및 알림
- **보안**
  - 결제 관련 API는 반드시 서버 사이드에서 처리
  - Webhook 검증 필수

### AI 분석 (Gemini API)

- **모델 분기 처리**
  - 무료 유저: `gemini-2.5-flash`
  - Pro 유저: `gemini-2.5-pro`
- **분석 내용**
  - 천간·지지 계산
  - 대운·세운 분석
  - 종합 사주팔자 해석
- **에러 처리**
  - API 호출 실패 시 재시도 로직 (최대 3회)
  - 사용량 차감 전 API 성공 여부 확인
  - 실패 시 사용자에게 명확한 에러 메시지 제공
- **프롬프트 최적화**
  - 일관된 사주 분석 결과를 위한 구조화된 프롬프트 작성
  - 천간·지지·대운·세운을 체계적으로 해석하는 프롬프트 설계
  - 분석 결과는 읽기 쉬운 형식으로 포맷팅

### 사용량 관리

- **카운팅 로직**
  - 분석 요청 **성공 시에만** 사용량 차감
  - 동시 요청으로 인한 초과 사용 방지 (트랜잭션 처리)
- **월별 초기화**
  - 구독 시작일 기준으로 월 단위 초기화
  - 예: 1월 15일 구독 시작 → 매월 15일 초기화
- **제한 초과 시**
  - Pro 업그레이드 안내 (무료 유저)
  - 다음 초기화 날짜 안내 (Pro 유저)

### 데이터 관리

- **영구 보관 정책**
  - 모든 분석 결과는 삭제하지 않고 영구 보관
  - 사용자는 대시보드에서 언제든 과거 분석 조회 가능
- **데이터 보안**
  - 개인정보 (생년월일시) 암호화 저장 권장
  - 환경 변수로 모든 API 키 관리 (.env 파일, Git 제외)
  - HTTPS 필수

### UX/UI

- **디자인 톤**
  - 심플하고 깔끔한 인터페이스
  - 카드 기반 레이아웃
  - 명확한 정보 위계
- **주요 강조 사항**
  - "AI 기반 정확한 분석" 강조
  - "합리적인 가격" (월 3,900원) 부각
  - "검사 내역 영구 보관" 명시
- **인터랙션**
  - 로딩 상태 명확히 표시 (AI 분석 시간 소요)
  - 남은 사용 횟수 항상 표시
  - 구독 상태 및 다음 결제일 명시
  - 모바일 반응형 디자인 필수

---

## 페이지 목록

### 1. 홈 (랜딩페이지) `/`

**접근 권한:** 인증 불필요 (공개)

**구성 요소:**

- **히어로 섹션**

  - 메인 타이틀: "AI가 풀어주는 당신의 사주팔자"
  - 서브 카피: Gemini 2.5 Pro 기반 정확한 분석
  - CTA 버튼: "무료로 시작하기" (1회 체험 강조)

- **주요 특징 (3개 카드)**

  1. **AI 기반 정확한 분석**

     - Google Gemini 2.5 Pro 모델 사용
     - 천간·지지·대운·세운 계산 및 해석

  2. **합리적인 가격**

     - 월 3,900원으로 월 10회 고품질 분석
     - 무료 체험 1회 제공!

  3. **검사 내역 영구 보관**
     - 모든 분석 결과를 대시보드에서 언제든 다시 확인 가능

- **가격 안내**

  - 무료: 1회 체험
  - Pro: 월 3,900원 / 월 10회

- **CTA 섹션**
  - "지금 시작하기" 버튼 (회원가입/로그인)

---

### 2. 대시보드 (분석 목록) `/dashboard`

**접근 권한:** 인증 필요

**구성 요소:**

- **상단 정보 카드**

  - 사용자 환영 메시지
  - 현재 구독 상태 배지 (무료 체험/Pro 구독 중)
  - 남은 분석 횟수 표시
    - 무료: "무료 체험: X/1회"
    - Pro: "이번 달 남은 분석: X/10회"
  - Pro가 아닌 경우: "Pro로 업그레이드" 버튼

- **새 분석하기 버튼** (주요 CTA, 상단 고정)

- **분석 이력 목록** (영구 보관)

  - 최신순 정렬
  - 각 항목 표시 정보:
    - 분석 날짜 및 시간
    - 생년월일 (일부 마스킹: 1990년 **월 **일)
    - 간단한 미리보기 텍스트 (첫 2-3줄)
    - "자세히 보기" 버튼
  - 페이지네이션 또는 무한 스크롤

- **하단 링크**
  - 구독 관리 페이지 이동

---

### 3. 새 분석하기 `/analysis/new`

**접근 권한:** 인증 필요

**구성 요소:**

- **상태 표시**

  - 남은 분석 횟수 (상단 배너 또는 카드)
  - 사용 제한 경고 (남은 횟수 0회인 경우)

- **입력 폼 (카드 형태)**

  - 생년월일 입력
    - DatePicker 컴포넌트
    - 연/월/일 선택
  - 출생 시간 입력
    - TimePicker 또는 Dropdown (시/분)
    - "모름" 옵션 제공
  - 양력/음력 선택
    - 라디오 버튼 또는 토글
  - 성별 선택
    - 라디오 버튼 (남/여)

- **분석하기 버튼**

  - 입력 값 검증 후 활성화
  - 클릭 시 로딩 상태 표시
  - 로딩 메시지: "AI가 사주를 분석하고 있습니다..."

- **제한 초과 시 표시**

  - 무료 유저가 1회 사용 완료: Pro 업그레이드 안내 CTA
  - Pro 유저가 10회 모두 사용: 다음 초기화 날짜 표시

- **완료 시 동작**
  - 자동으로 분석 상세보기 페이지로 이동

---

### 4. 분석 상세보기 `/analysis/[id]`

**접근 권한:** 인증 필요 (본인의 분석만 조회 가능)

**구성 요소:**

- **분석 정보 헤더**

  - 분석 날짜 및 시간
  - 생년월일시 정보
  - 양력/음력 구분
  - 성별

- **사주 분석 결과** (섹션별 구분)

  1. **사주팔자 기본 구성**

     - 천간·지지 배치
     - 오행 분석

  2. **성격 및 기질**

     - 성격 특성
     - 장단점

  3. **대운·세운 분석**

     - 현재 대운 시기
     - 올해 세운
     - 주요 시기별 흐름

  4. **운세 종합**

     - 직업운 및 재물운
     - 건강운
     - 연애/결혼운
     - 대인관계운

  5. **조언 및 제안**
     - 긍정적인 방향성
     - 주의할 점

- **액션 버튼**
  - 인쇄 / PDF 저장
  - 공유하기 (선택사항)
  - 대시보드로 돌아가기

---

### 5. 구독 관리 `/subscription`

**접근 권한:** 인증 필요

**구성 요소:**

#### **무료 유저 화면**

- **현재 상태 카드**
  - 요금제: 무료 체험
  - 사용 현황: X/1회 사용
- **Pro 요금제 안내 카드**
  - 제목: "Pro로 업그레이드하세요"
  - 혜택 목록:
    - ✅ 월 10회 분석 가능
    - ✅ 더 정확한 AI 모델 (Gemini 2.5 Pro)
    - ✅ 모든 분석 결과 영구 보관
  - 가격: 월 3,900원
  - "Pro 구독하기" 버튼
    - 클릭 시 토스페이먼츠 결제 SDK 호출

#### **Pro 유저 화면 (정상 구독 중)**

- **구독 정보 카드**

  - 요금제: Pro 구독 중 ✨
  - 구독 시작일
  - 다음 결제일
  - 결제 금액: 월 3,900원

- **사용 현황 카드**

  - 이번 달 사용: X/10회
  - 다음 초기화: YYYY-MM-DD

- **결제 수단 정보**

  - 카드사
  - 카드번호 (마지막 4자리)

- **결제 이력**

  - 최근 결제 내역 리스트
  - 날짜, 금액, 상태

- **구독 취소 버튼**
  - 클릭 시 확인 모달:
    - "정말 구독을 취소하시겠습니까?"
    - 안내: "다음 결제일(YYYY-MM-DD)까지 Pro 혜택이 유지됩니다."
    - 확인 / 취소

#### **구독 취소 상태 화면**

- **구독 정보 카드**

  - 요금제: Pro (취소 예정) ⏸️
  - 혜택 만료일: YYYY-MM-DD
  - 안내: "만료일까지 Pro 혜택을 계속 사용할 수 있습니다"

- **사용 현황 카드**

  - 남은 사용: X/10회
  - 만료 후: 무료 플랜으로 전환

- **구독 재개 버튼**
  - 클릭 시 확인 모달:
    - "구독을 재개하시겠습니까?"
    - 안내: "다음 결제일부터 정기결제가 다시 시작됩니다."
    - 확인 / 취소

---

### 인증 관련 페이지 (Clerk 기본 제공)

- `/sign-in` - 로그인
- `/sign-up` - 회원가입
- `/user-profile` - 프로필 관리 (선택사항)
