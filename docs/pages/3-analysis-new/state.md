# ÏÉÅÌÉúÍ¥ÄÎ¶¨ ÏÑ§Í≥Ñ: ÏÉà Î∂ÑÏÑùÌïòÍ∏∞ ÌéòÏù¥ÏßÄ (`/analysis/new`)

## Í∞úÏöî

Î≥∏ Î¨∏ÏÑúÎäî ÏÇ¨Ï£º Î∂ÑÏÑù ÏöîÏ≤≠ ÌéòÏù¥ÏßÄ(`/analysis/new`)Ïùò ÏÉÅÌÉúÍ¥ÄÎ¶¨ ÏÑ§Í≥ÑÎ•º Ï†ïÏùòÌï©ÎãàÎã§. Context + useReducer Ìå®ÌÑ¥ÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ Î≥µÏû°Ìïú Ìèº ÏÉÅÌÉú, ÏÇ¨Ïö©Îüâ Ï†ïÎ≥¥, Î°úÎî© Î∞è ÏóêÎü¨ ÏÉÅÌÉúÎ•º Ï≤¥Í≥ÑÏ†ÅÏúºÎ°ú Í¥ÄÎ¶¨Ìï©ÎãàÎã§.

**ÏÑ§Í≥Ñ ÏõêÏπô**:
- Context + useReducerÎ•º ÏÇ¨Ïö©Ìïú Î°úÏª¨ ÏÉÅÌÉú Í¥ÄÎ¶¨
- react-hook-formÏùÑ ÏÇ¨Ïö©Ìïú Ìèº Í≤ÄÏ¶ù Î∞è ÏûÖÎ†• Í¥ÄÎ¶¨
- React QueryÎ•º ÏÇ¨Ïö©Ìïú ÏÑúÎ≤Ñ ÏÉÅÌÉú Í¥ÄÎ¶¨ (ÏÇ¨Ïö©Îüâ Ï°∞Ìöå, Î∂ÑÏÑù ÏöîÏ≤≠)
- Îã®Î∞©Ìñ• Îç∞Ïù¥ÌÑ∞ ÌùêÎ¶Ñ (Flux Ìå®ÌÑ¥)
- Î™ÖÌôïÌïú ÏÉÅÌÉú Ï†ÑÏù¥ Î∞è ÏóêÎü¨ Ï≤òÎ¶¨

---

## 1. ÌéòÏù¥ÏßÄ Íµ¨ÏÑ± ÏöîÏÜå

### 1.1 ÌôîÎ©¥ Íµ¨Ï°∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  [‚Üê ÎåÄÏãúÎ≥¥ÎìúÎ°ú]                             ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ  ÏÉà Î∂ÑÏÑùÌïòÍ∏∞                                 ‚îÇ
‚îÇ  AIÍ∞Ä ÎãπÏã†Ïùò ÏÇ¨Ï£ºÎ•º Î∂ÑÏÑùÌï©ÎãàÎã§               ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ üìä ÎÇ®ÏùÄ Î∂ÑÏÑù ÌöüÏàò: 7/10Ìöå              ‚îÇ ‚îÇ
‚îÇ  ‚îÇ Îã§Ïùå Ï¥àÍ∏∞Ìôî: 2025-11-15                ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ  ÏÉùÎÖÑÏõîÏùº *                                  ‚îÇ
‚îÇ  [DatePicker: YYYY-MM-DD]                   ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ  Ï∂úÏÉù ÏãúÍ∞Ñ                                   ‚îÇ
‚îÇ  [TimePicker: HH:MM] [ ] Î™®Î¶Ñ              ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ  ÏñëÎ†•/ÏùåÎ†• *                                 ‚îÇ
‚îÇ  ( ) ÏñëÎ†•  ( ) ÏùåÎ†•                         ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ  ÏÑ±Î≥Ñ *                                      ‚îÇ
‚îÇ  ( ) ÎÇ®ÏÑ±  ( ) Ïó¨ÏÑ±                         ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ  [Î∂ÑÏÑùÌïòÍ∏∞]                                  ‚îÇ
‚îÇ                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 1.2 Ï£ºÏöî Ïª¥Ìè¨ÎÑåÌä∏

1. **UsageDisplay**: ÏÇ¨Ïö©Îüâ ÌëúÏãú Ïª¥Ìè¨ÎÑåÌä∏ (Context ÏÜåÎπÑ)
2. **AnalysisForm**: Ìèº ÏûÖÎ†• Ïª¥Ìè¨ÎÑåÌä∏ (react-hook-form)
3. **LoadingOverlay**: Î°úÎî© ÏÉÅÌÉú ÌëúÏãú (Ï†ÑÏó≠ ÎòêÎäî Î°úÏª¨)
4. **ErrorAlert**: ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú

---

## 2. Í¥ÄÎ¶¨ ÎåÄÏÉÅ ÏÉÅÌÉú Î∂ÑÎ•ò

### 2.1 ÏÉÅÌÉú Îç∞Ïù¥ÌÑ∞ (State)

| ÏÉÅÌÉú | ÌÉÄÏûÖ | Ï†ÄÏû• ÏúÑÏπò | Ï¥àÍ∏∞Í∞í | ÏÑ§Î™Ö |
|------|------|----------|--------|------|
| **usageInfo** | `UsageInfo` | Context (Reducer) | `null` | ÏÇ¨Ïö©Îüâ Ï†ïÎ≥¥ (ÎÇ®ÏùÄ ÌöüÏàò, Ï†úÌïú, Îã§Ïùå Î¶¨ÏÖã ÎÇ†Ïßú) |
| **isLoadingUsage** | `boolean` | React Query | `false` | ÏÇ¨Ïö©Îüâ Î°úÎî© ÏÉÅÌÉú |
| **usageError** | `Error \| null` | React Query | `null` | ÏÇ¨Ïö©Îüâ Ï°∞Ìöå ÏóêÎü¨ |
| **formData** | `AnalysisFormInput` | react-hook-form | ÏïÑÎûò Ï∞∏Ï°∞ | Ìèº ÏûÖÎ†• Îç∞Ïù¥ÌÑ∞ |
| **isSubmitting** | `boolean` | react-hook-form | `false` | Ìèº Ï†úÏ∂ú Ï§ë ÏÉÅÌÉú |
| **submitError** | `string \| null` | Context (Reducer) | `null` | Î∂ÑÏÑù ÏöîÏ≤≠ ÏóêÎü¨ Î©îÏãúÏßÄ |
| **analysisResult** | `AnalysisResult \| null` | React Query | `null` | Î∂ÑÏÑù Í≤∞Í≥º (ÏÑ±Í≥µ Ïãú) |

**formData Ï¥àÍ∏∞Í∞í**:
```typescript
{
  birthDate: undefined,        // Date
  birthTime: undefined,        // string (HH:MM) | undefined
  birthTimeUnknown: false,     // boolean
  isLunar: false,              // boolean
  gender: undefined,           // 'male' | 'female'
}
```

### 2.2 ÌååÏÉù Îç∞Ïù¥ÌÑ∞ (Derived State, ÏÉÅÌÉú ÏïÑÎãò)

| Îç∞Ïù¥ÌÑ∞ | Í≥ÑÏÇ∞ Î∞©Ïãù | ÏÑ§Î™Ö |
|--------|----------|------|
| **canSubmit** | `usageInfo?.remaining > 0 && formValid` | Î∂ÑÏÑù ÏöîÏ≤≠ Í∞ÄÎä• Ïó¨Î∂Ä |
| **usageExceeded** | `usageInfo?.remaining === 0` | ÏÇ¨Ïö©Îüâ Ï¥àÍ≥º Ïó¨Î∂Ä |
| **isLoading** | `isLoadingUsage \|\| isSubmitting` | Ï†ÑÏ≤¥ Î°úÎî© ÏÉÅÌÉú |

---

## 3. ÏÉÅÌÉú Ï†ÑÏù¥ ÌÖåÏù¥Î∏î

### 3.1 ÏÇ¨Ïö©Îüâ Ï†ïÎ≥¥ ÏÉÅÌÉú

| ÌòÑÏû¨ ÏÉÅÌÉú | Ïù¥Î≤§Ìä∏ | Ï°∞Í±¥ | Îã§Ïùå ÏÉÅÌÉú | ÌôîÎ©¥ Î≥ÄÌôî |
|----------|--------|------|----------|----------|
| `null` | `FETCH_USAGE_START` | - | `isLoadingUsage: true` | Ïä§ÏºàÎ†àÌÜ§ Î°úÎî© ÌëúÏãú |
| `isLoadingUsage: true` | `FETCH_USAGE_SUCCESS` | API ÏÑ±Í≥µ | `usageInfo` ÏÑ§Ï†ï | ÎÇ®ÏùÄ ÌöüÏàò ÌëúÏãú, Ìèº ÌôúÏÑ±Ìôî |
| `isLoadingUsage: true` | `FETCH_USAGE_ERROR` | API Ïã§Ìå® | `usageError` ÏÑ§Ï†ï | ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú, Ïû¨ÏãúÎèÑ Î≤ÑÌäº |
| `usageInfo` | `USAGE_REFRESH` | Î∂ÑÏÑù ÏÑ±Í≥µ ÌõÑ | `usageInfo.remaining--` | ÎÇ®ÏùÄ ÌöüÏàò Í∞êÏÜå |

### 3.2 Ìèº ÏÉÅÌÉú

| ÌòÑÏû¨ ÏÉÅÌÉú | Ïù¥Î≤§Ìä∏ | Ï°∞Í±¥ | Îã§Ïùå ÏÉÅÌÉú | ÌôîÎ©¥ Î≥ÄÌôî |
|----------|--------|------|----------|----------|
| Ï¥àÍ∏∞ | `INPUT_CHANGE` | ÏÇ¨Ïö©Ïûê ÏûÖÎ†• | `formData` ÏóÖÎç∞Ïù¥Ìä∏ | Ïã§ÏãúÍ∞Ñ ÏûÖÎ†• Î∞òÏòÅ |
| Ïú†Ìö® | `TOGGLE_BIRTH_TIME_UNKNOWN` | Î™®Î¶Ñ Ï≤¥ÌÅ¨ | `birthTime: undefined` | ÏãúÍ∞Ñ ÏûÖÎ†• ÎπÑÌôúÏÑ±Ìôî |
| Ïú†Ìö® | `FORM_SUBMIT` | Í≤ÄÏ¶ù ÌÜµÍ≥º | `isSubmitting: true` | Î°úÎî© Ïò§Î≤ÑÎ†àÏù¥ ÌëúÏãú |
| `isSubmitting` | `SUBMIT_SUCCESS` | API ÏÑ±Í≥µ | - | `/analysis/[id]` ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô |
| `isSubmitting` | `SUBMIT_ERROR` | API Ïã§Ìå® | `submitError` ÏÑ§Ï†ï, `isSubmitting: false` | ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú, Ìèº Ïú†ÏßÄ |

### 3.3 ÏÇ¨Ïö©Îüâ Ï¥àÍ≥º ÏÉÅÌÉú

| ÏÉÅÌÉú | Ï°∞Í±¥ | ÌôîÎ©¥ Î≥ÄÌôî |
|------|------|----------|
| **ÏÇ¨Ïö© Í∞ÄÎä•** | `remaining > 0` | Ìèº ÌôúÏÑ±Ìôî, Ï†úÏ∂ú Î≤ÑÌäº ÌôúÏÑ±Ìôî |
| **ÏÇ¨Ïö©Îüâ Ï¥àÍ≥º** | `remaining === 0` | Ìèº ÎπÑÌôúÏÑ±Ìôî, Í≤ΩÍ≥† Î©îÏãúÏßÄ ÌëúÏãú, Pro ÏóÖÍ∑∏Î†àÏù¥Îìú Î≤ÑÌäº (Î¨¥Î£å Ïú†Ï†Ä) |
| **Íµ¨ÎèÖ ÎßåÎ£å** | `SUBSCRIPTION_EXPIRED` ÏóêÎü¨ | ÎßåÎ£å Î©îÏãúÏßÄ, Ïû¨Íµ¨ÎèÖ Î≤ÑÌäº |

---

## 4. Flux Ìå®ÌÑ¥ ÌùêÎ¶ÑÎèÑ

### 4.1 ÏÇ¨Ïö©Îüâ Ï°∞Ìöå ÌùêÎ¶Ñ

```mermaid
graph LR
    A[Component Mount] -->|dispatch| B[FETCH_USAGE_START]
    B --> C[React Query: useQuery]
    C -->|API Call| D{Success?}
    D -->|Yes| E[FETCH_USAGE_SUCCESS]
    D -->|No| F[FETCH_USAGE_ERROR]
    E --> G[Store: usageInfo ÏóÖÎç∞Ïù¥Ìä∏]
    F --> H[Store: usageError ÏÑ§Ï†ï]
    G --> I[View: ÎÇ®ÏùÄ ÌöüÏàò ÌëúÏãú]
    H --> J[View: ÏóêÎü¨ Î©îÏãúÏßÄ]
```

### 4.2 Î∂ÑÏÑù ÏöîÏ≤≠ ÌùêÎ¶Ñ

```mermaid
graph TD
    A[User: Î∂ÑÏÑùÌïòÍ∏∞ ÌÅ¥Î¶≠] -->|dispatch| B[FORM_SUBMIT]
    B --> C{Ìèº Í≤ÄÏ¶ù}
    C -->|Ïã§Ìå®| D[View: ÏóêÎü¨ ÌëúÏãú]
    C -->|ÏÑ±Í≥µ| E[SUBMIT_START]
    E --> F[Store: isSubmitting = true]
    F --> G[View: Î°úÎî© Ïò§Î≤ÑÎ†àÏù¥]
    G --> H[React Query: useMutation]
    H -->|API Call| I{Success?}
    I -->|Yes| J[SUBMIT_SUCCESS]
    I -->|No| K[SUBMIT_ERROR]
    J --> L[Store: analysisResult Ï†ÄÏû•]
    L --> M[View: /analysis/id Ïù¥Îèô]
    K --> N[Store: submitError ÏÑ§Ï†ï]
    N --> O[View: ÏóêÎü¨ Î©îÏãúÏßÄ, Ìèº Ïú†ÏßÄ]
```

### 4.3 ÏÇ¨Ïö©Îüâ Ï¥àÍ≥º ÌùêÎ¶Ñ

```mermaid
graph LR
    A[FETCH_USAGE_SUCCESS] --> B{remaining === 0?}
    B -->|Yes| C[USAGE_EXCEEDED]
    B -->|No| D[USAGE_AVAILABLE]
    C --> E[Store: canSubmit = false]
    E --> F[View: Ìèº ÎπÑÌôúÏÑ±Ìôî]
    F --> G{subscriptionTier?}
    G -->|free| H[View: Pro ÏóÖÍ∑∏Î†àÏù¥Îìú Î≤ÑÌäº]
    G -->|pro| I[View: Îã§Ïùå Î¶¨ÏÖã ÎÇ†Ïßú ÌëúÏãú]
    D --> J[Store: canSubmit = true]
    J --> K[View: Ìèº ÌôúÏÑ±Ìôî]
```

---

## 5. Context ÏÑ§Í≥Ñ

### 5.1 State Ïù∏ÌÑ∞ÌéòÏù¥Ïä§

```typescript
// src/features/analysis/context/analysis-new-context.tsx

export interface UsageInfo {
  remaining: number;
  limit: number;
  subscriptionTier: 'free' | 'pro';
  nextResetDate?: Date; // Pro Ïú†Ï†ÄÎßå
}

export interface AnalysisFormInput {
  birthDate: Date | undefined;
  birthTime: string | undefined; // HH:MM
  birthTimeUnknown: boolean;
  isLunar: boolean;
  gender: 'male' | 'female' | undefined;
}

export interface AnalysisNewState {
  // ÏÇ¨Ïö©Îüâ Ï†ïÎ≥¥
  usageInfo: UsageInfo | null;
  isLoadingUsage: boolean;
  usageError: Error | null;

  // Ìèº Ï†úÏ∂ú ÏÉÅÌÉú
  isSubmitting: boolean;
  submitError: string | null;
}

export type AnalysisNewAction =
  | { type: 'FETCH_USAGE_START' }
  | { type: 'FETCH_USAGE_SUCCESS'; payload: UsageInfo }
  | { type: 'FETCH_USAGE_ERROR'; payload: Error }
  | { type: 'SUBMIT_START' }
  | { type: 'SUBMIT_SUCCESS' }
  | { type: 'SUBMIT_ERROR'; payload: string }
  | { type: 'RESET_ERROR' }
  | { type: 'USAGE_REFRESH'; payload: UsageInfo }; // Î∂ÑÏÑù ÏÑ±Í≥µ ÌõÑ ÏÇ¨Ïö©Îüâ Í∞±Ïã†

export interface AnalysisNewContextValue {
  state: AnalysisNewState;
  dispatch: React.Dispatch<AnalysisNewAction>;

  // ÌååÏÉù Îç∞Ïù¥ÌÑ∞
  canSubmit: boolean;
  usageExceeded: boolean;
  isLoading: boolean;

  // Ïï°ÏÖò Ìï®Ïàò
  fetchUsage: () => Promise<void>;
  submitAnalysis: (data: AnalysisFormInput) => Promise<string>; // returns analysis ID
  resetError: () => void;
}
```

### 5.2 Reducer Íµ¨ÌòÑ

```typescript
const initialState: AnalysisNewState = {
  usageInfo: null,
  isLoadingUsage: false,
  usageError: null,
  isSubmitting: false,
  submitError: null,
};

function analysisNewReducer(
  state: AnalysisNewState,
  action: AnalysisNewAction
): AnalysisNewState {
  switch (action.type) {
    case 'FETCH_USAGE_START':
      return {
        ...state,
        isLoadingUsage: true,
        usageError: null,
      };

    case 'FETCH_USAGE_SUCCESS':
      return {
        ...state,
        isLoadingUsage: false,
        usageInfo: action.payload,
        usageError: null,
      };

    case 'FETCH_USAGE_ERROR':
      return {
        ...state,
        isLoadingUsage: false,
        usageError: action.payload,
      };

    case 'SUBMIT_START':
      return {
        ...state,
        isSubmitting: true,
        submitError: null,
      };

    case 'SUBMIT_SUCCESS':
      return {
        ...state,
        isSubmitting: false,
        submitError: null,
      };

    case 'SUBMIT_ERROR':
      return {
        ...state,
        isSubmitting: false,
        submitError: action.payload,
      };

    case 'RESET_ERROR':
      return {
        ...state,
        submitError: null,
        usageError: null,
      };

    case 'USAGE_REFRESH':
      return {
        ...state,
        usageInfo: action.payload,
      };

    default:
      return state;
  }
}
```

### 5.3 Context Provider Íµ¨ÌòÑ

```typescript
export function AnalysisNewProvider({ children }: { children: React.ReactNode }) {
  const [state, dispatch] = useReducer(analysisNewReducer, initialState);
  const router = useRouter();

  // React Query: ÏÇ¨Ïö©Îüâ Ï°∞Ìöå
  const { refetch: refetchUsage } = useQuery({
    queryKey: ['usage'],
    queryFn: async () => {
      const response = await apiClient.get<UsageInfo>('/api/usage');
      return response.data;
    },
    onSuccess: (data) => {
      dispatch({ type: 'FETCH_USAGE_SUCCESS', payload: data });
    },
    onError: (error) => {
      dispatch({ type: 'FETCH_USAGE_ERROR', payload: error as Error });
    },
  });

  // React Query: Î∂ÑÏÑù ÏöîÏ≤≠
  const analysisMutation = useMutation({
    mutationFn: async (data: AnalysisFormInput) => {
      const response = await apiClient.post<{ id: string }>('/api/analyses', {
        birthDate: data.birthDate?.toISOString().split('T')[0],
        birthTime: data.birthTimeUnknown ? null : data.birthTime,
        isLunar: data.isLunar,
        gender: data.gender,
      });
      return response.data;
    },
  });

  // Ïï°ÏÖò Ìï®Ïàò
  const fetchUsage = async () => {
    dispatch({ type: 'FETCH_USAGE_START' });
    await refetchUsage();
  };

  const submitAnalysis = async (data: AnalysisFormInput): Promise<string> => {
    dispatch({ type: 'SUBMIT_START' });
    try {
      const result = await analysisMutation.mutateAsync(data);
      dispatch({ type: 'SUBMIT_SUCCESS' });

      // ÏÇ¨Ïö©Îüâ Í∞±Ïã†
      await refetchUsage();

      return result.id;
    } catch (error) {
      const message = extractApiErrorMessage(error);
      dispatch({ type: 'SUBMIT_ERROR', payload: message });
      throw error;
    }
  };

  const resetError = () => {
    dispatch({ type: 'RESET_ERROR' });
  };

  // ÌååÏÉù Îç∞Ïù¥ÌÑ∞
  const canSubmit = Boolean(
    state.usageInfo && state.usageInfo.remaining > 0 && !state.isSubmitting
  );
  const usageExceeded = state.usageInfo?.remaining === 0;
  const isLoading = state.isLoadingUsage || state.isSubmitting;

  const value: AnalysisNewContextValue = {
    state,
    dispatch,
    canSubmit,
    usageExceeded,
    isLoading,
    fetchUsage,
    submitAnalysis,
    resetError,
  };

  return (
    <AnalysisNewContext.Provider value={value}>
      {children}
    </AnalysisNewContext.Provider>
  );
}

export const useAnalysisNew = () => {
  const context = useContext(AnalysisNewContext);
  if (!context) {
    throw new Error('useAnalysisNew must be used within AnalysisNewProvider');
  }
  return context;
};
```

---

## 6. Ïª¥Ìè¨ÎÑåÌä∏ Í≥ÑÏ∏µ Íµ¨Ï°∞

```
AnalysisNewProvider (Context)
  ‚îî‚îÄ AnalysisNewPage
       ‚îú‚îÄ UsageDisplay (ÏÇ¨Ïö©Îüâ ÌëúÏãú)
       ‚îÇ    ‚îú‚îÄ ÎÇ®ÏùÄ ÌöüÏàò Î∞∞ÏßÄ
       ‚îÇ    ‚îî‚îÄ Îã§Ïùå Î¶¨ÏÖã ÎÇ†Ïßú (ProÎßå)
       ‚îÇ
       ‚îú‚îÄ AnalysisForm (react-hook-form)
       ‚îÇ    ‚îú‚îÄ DatePicker (ÏÉùÎÖÑÏõîÏùº)
       ‚îÇ    ‚îú‚îÄ TimePicker (Ï∂úÏÉù ÏãúÍ∞Ñ)
       ‚îÇ    ‚îú‚îÄ Checkbox (Î™®Î¶Ñ)
       ‚îÇ    ‚îú‚îÄ RadioGroup (ÏñëÎ†•/ÏùåÎ†•)
       ‚îÇ    ‚îú‚îÄ RadioGroup (ÏÑ±Î≥Ñ)
       ‚îÇ    ‚îî‚îÄ SubmitButton
       ‚îÇ
       ‚îú‚îÄ LoadingOverlay (Î°úÎî© Ïãú)
       ‚îî‚îÄ ErrorAlert (ÏóêÎü¨ Ïãú)
```

---

## 7. ÎÖ∏Ï∂ú Ïù∏ÌÑ∞ÌéòÏù¥Ïä§

### 7.1 ContextÏóêÏÑú ÌïòÏúÑ Ïª¥Ìè¨ÎÑåÌä∏Ïóê ÎÖ∏Ï∂úÎêòÎäî Îç∞Ïù¥ÌÑ∞

| Î≥ÄÏàò/Ìï®Ïàò | ÌÉÄÏûÖ | ÏÑ§Î™Ö |
|----------|------|------|
| `state.usageInfo` | `UsageInfo \| null` | ÏÇ¨Ïö©Îüâ Ï†ïÎ≥¥ |
| `state.isLoadingUsage` | `boolean` | ÏÇ¨Ïö©Îüâ Î°úÎî© Ï§ë |
| `state.usageError` | `Error \| null` | ÏÇ¨Ïö©Îüâ Ï°∞Ìöå ÏóêÎü¨ |
| `state.isSubmitting` | `boolean` | Î∂ÑÏÑù ÏöîÏ≤≠ Ï§ë |
| `state.submitError` | `string \| null` | Î∂ÑÏÑù ÏöîÏ≤≠ ÏóêÎü¨ |
| `canSubmit` | `boolean` | Ï†úÏ∂ú Í∞ÄÎä• Ïó¨Î∂Ä |
| `usageExceeded` | `boolean` | ÏÇ¨Ïö©Îüâ Ï¥àÍ≥º Ïó¨Î∂Ä |
| `isLoading` | `boolean` | Ï†ÑÏ≤¥ Î°úÎî© ÏÉÅÌÉú |
| `fetchUsage()` | `() => Promise<void>` | ÏÇ¨Ïö©Îüâ Ïû¨Ï°∞Ìöå |
| `submitAnalysis(data)` | `(data) => Promise<string>` | Î∂ÑÏÑù ÏöîÏ≤≠ (Î∂ÑÏÑù ID Î∞òÌôò) |
| `resetError()` | `() => void` | ÏóêÎü¨ Ï¥àÍ∏∞Ìôî |

### 7.2 react-hook-form Ìèº Îç∞Ïù¥ÌÑ∞

| ÌïÑÎìú | ÌÉÄÏûÖ | Í≤ÄÏ¶ù Í∑úÏπô |
|------|------|----------|
| `birthDate` | `Date` | ÌïÑÏàò, 1900-01-01 ~ Ïò§Îäò |
| `birthTime` | `string \| undefined` | ÏÑ†ÌÉù, HH:MM ÌòïÏãù |
| `birthTimeUnknown` | `boolean` | ÏÑ†ÌÉù, trueÎ©¥ birthTime Î¨¥Ïãú |
| `isLunar` | `boolean` | ÌïÑÏàò, Í∏∞Î≥∏Í∞í false |
| `gender` | `'male' \| 'female'` | ÌïÑÏàò |

---

## 8. Ï£ºÏöî ÏãúÎÇòÎ¶¨Ïò§Î≥Ñ ÏÉÅÌÉú ÌùêÎ¶Ñ

### 8.1 Ï†ïÏÉÅ ÌîåÎ°úÏö∞ (Pro Ïú†Ï†Ä, ÎÇ®ÏùÄ ÌöüÏàò ÏûàÏùå)

```
1. ÌéòÏù¥ÏßÄ ÎßàÏö¥Ìä∏
   ‚Üí FETCH_USAGE_START
   ‚Üí React Query: GET /api/usage
   ‚Üí FETCH_USAGE_SUCCESS
   ‚Üí usageInfo = { remaining: 7, limit: 10, tier: 'pro', nextResetDate }
   ‚Üí View: "ÎÇ®ÏùÄ Î∂ÑÏÑù: 7/10Ìöå" ÌëúÏãú

2. Ìèº ÏûÖÎ†•
   ‚Üí react-hook-form: formData ÏóÖÎç∞Ïù¥Ìä∏
   ‚Üí Ïã§ÏãúÍ∞Ñ Í≤ÄÏ¶ù

3. Î∂ÑÏÑùÌïòÍ∏∞ ÌÅ¥Î¶≠
   ‚Üí SUBMIT_START
   ‚Üí isSubmitting = true
   ‚Üí View: LoadingOverlay ÌëúÏãú ("AIÍ∞Ä ÏÇ¨Ï£ºÎ•º Î∂ÑÏÑùÌïòÍ≥† ÏûàÏäµÎãàÎã§...")
   ‚Üí React Query: POST /api/analyses
   ‚Üí SUBMIT_SUCCESS
   ‚Üí router.push(`/analysis/${analysisId}`)
```

### 8.2 ÏÇ¨Ïö©Îüâ Ï¥àÍ≥º (Î¨¥Î£å Ïú†Ï†Ä, 1Ìöå ÏÇ¨Ïö© ÏôÑÎ£å)

```
1. ÌéòÏù¥ÏßÄ ÎßàÏö¥Ìä∏
   ‚Üí FETCH_USAGE_START
   ‚Üí React Query: GET /api/usage
   ‚Üí FETCH_USAGE_SUCCESS
   ‚Üí usageInfo = { remaining: 0, limit: 1, tier: 'free' }
   ‚Üí usageExceeded = true
   ‚Üí View: Ìèº ÎπÑÌôúÏÑ±Ìôî, "Î¨¥Î£å Ï≤¥Ìóò 1ÌöåÎ•º Î™®Îëê ÏÇ¨Ïö©ÌïòÏòÄÏäµÎãàÎã§" Î©îÏãúÏßÄ
   ‚Üí View: "ProÎ°ú ÏóÖÍ∑∏Î†àÏù¥Îìú" Î≤ÑÌäº ÌëúÏãú
```

### 8.3 Î∂ÑÏÑù ÏöîÏ≤≠ Ïã§Ìå® (Gemini API Ïò§Î•ò)

```
1. Î∂ÑÏÑùÌïòÍ∏∞ ÌÅ¥Î¶≠
   ‚Üí SUBMIT_START
   ‚Üí React Query: POST /api/analyses
   ‚Üí API ÏóêÎü¨ (503 Service Unavailable)
   ‚Üí SUBMIT_ERROR
   ‚Üí submitError = "ÏùºÏãúÏ†ÅÏù∏ ÏÑúÎπÑÏä§ Ïû•Ïï†Í∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§"
   ‚Üí isSubmitting = false
   ‚Üí View: ErrorAlert ÌëúÏãú, "Ïû¨ÏãúÎèÑ" Î≤ÑÌäº
   ‚Üí ÏÇ¨Ïö©ÏûêÍ∞Ä Ïû¨ÏãúÎèÑ Î≤ÑÌäº ÌÅ¥Î¶≠
   ‚Üí Îã§Ïãú SUBMIT_START...
```

### 8.4 Íµ¨ÎèÖ ÎßåÎ£å

```
1. Î∂ÑÏÑùÌïòÍ∏∞ ÌÅ¥Î¶≠
   ‚Üí SUBMIT_START
   ‚Üí React Query: POST /api/analyses
   ‚Üí API ÏóêÎü¨ (403 SUBSCRIPTION_EXPIRED)
   ‚Üí SUBMIT_ERROR
   ‚Üí submitError = "Pro Íµ¨ÎèÖÏù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§"
   ‚Üí View: "Pro Ïû¨Íµ¨ÎèÖÌïòÍ∏∞" Î≤ÑÌäº
   ‚Üí Î≤ÑÌäº ÌÅ¥Î¶≠ ‚Üí router.push('/subscription')
```

---

## 9. ÏóêÎü¨ Ï≤òÎ¶¨ Ï†ÑÎûµ

### 9.1 ÏóêÎü¨ ÌÉÄÏûÖÎ≥Ñ Ï≤òÎ¶¨

| ÏóêÎü¨ ÏΩîÎìú | HTTP ÏÉÅÌÉú | Î©îÏãúÏßÄ | Ïï°ÏÖò |
|----------|----------|--------|------|
| `USAGE_LIMIT_EXCEEDED` | 400 | "Ïù¥Î≤à Îã¨ Î∂ÑÏÑù ÌöüÏàòÎ•º Î™®Îëê ÏÇ¨Ïö©ÌïòÏòÄÏäµÎãàÎã§" | Pro ÏóÖÍ∑∏Î†àÏù¥Îìú Î≤ÑÌäº (Î¨¥Î£å) / Îã§Ïùå Î¶¨ÏÖã ÎÇ†Ïßú ÌëúÏãú (Pro) |
| `SUBSCRIPTION_EXPIRED` | 403 | "Pro Íµ¨ÎèÖÏù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§" | Ïû¨Íµ¨ÎèÖ Î≤ÑÌäº |
| `AI_SERVICE_ERROR` | 503 | "ÏùºÏãúÏ†ÅÏù∏ ÏÑúÎπÑÏä§ Ïû•Ïï†Í∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§" | Ïû¨ÏãúÎèÑ Î≤ÑÌäº, Í≥†Í∞ù ÏßÄÏõê ÎßÅÌÅ¨ |
| `VALIDATION_ERROR` | 400 | ÌïÑÎìúÎ≥Ñ ÏóêÎü¨ Î©îÏãúÏßÄ | Ïù∏ÎùºÏù∏ ÌëúÏãú, Ìï¥Îãπ ÌïÑÎìú Ìè¨Ïª§Ïä§ |
| `UNAUTHORIZED` | 401 | "Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§" | Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Î¶¨Îã§Ïù¥Î†âÌä∏ |
| `NETWORK_ERROR` | - | "ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî" | Ïû¨ÏãúÎèÑ Î≤ÑÌäº |

### 9.2 ÏóêÎü¨ ÌëúÏãú ÏúÑÏπò

- **Ï†ÑÏó≠ ÏóêÎü¨** (Ïù∏Ï¶ù, ÎÑ§Ìä∏ÏõåÌÅ¨): Toast ÎòêÎäî ÏÉÅÎã® Î∞∞ÎÑà
- **ÏÇ¨Ïö©Îüâ ÏóêÎü¨**: UsageDisplay Ïª¥Ìè¨ÎÑåÌä∏ ÎÇ¥ Alert
- **Ìèº Í≤ÄÏ¶ù ÏóêÎü¨**: Í∞Å ÌïÑÎìú ÌïòÎã® Ïù∏ÎùºÏù∏ Î©îÏãúÏßÄ
- **Ï†úÏ∂ú ÏóêÎü¨**: Ìèº ÏÉÅÎã® Alert

---

## 10. ÏÑ±Îä• ÏµúÏ†ÅÌôî

### 10.1 React Query Ï∫êÏã±

```typescript
useQuery({
  queryKey: ['usage'],
  staleTime: 5 * 60 * 1000, // 5Î∂ÑÍ∞Ñ Ïã†ÏÑ†
  cacheTime: 10 * 60 * 1000, // 10Î∂ÑÍ∞Ñ Ï∫êÏãú
  refetchOnWindowFocus: true, // ÏúàÎèÑÏö∞ Ìè¨Ïª§Ïä§ Ïãú Ïû¨Ï°∞Ìöå
});
```

### 10.2 Î∂àÌïÑÏöîÌïú Î¶¨Î†åÎçîÎßÅ Î∞©ÏßÄ

- `useCallback`ÏúºÎ°ú Ïï°ÏÖò Ìï®Ïàò Î©îÎ™®Ïù¥Ï†úÏù¥ÏÖò
- `useMemo`Î°ú ÌååÏÉù Îç∞Ïù¥ÌÑ∞ Í≥ÑÏÇ∞ ÏµúÏ†ÅÌôî
- react-hook-formÏùò `watch`Î•º ÏµúÏÜåÌôî

### 10.3 ÎÇôÍ¥ÄÏ†Å ÏóÖÎç∞Ïù¥Ìä∏

Î∂ÑÏÑù ÏöîÏ≤≠ ÏÑ±Í≥µ Ïãú Ï¶âÏãú `/analysis/[id]`Î°ú Ïù¥ÎèôÌïòÍ≥†, Î∞±Í∑∏ÎùºÏö¥ÎìúÏóêÏÑú ÏÇ¨Ïö©Îüâ Í∞±Ïã†

---

## 11. Ï†ëÍ∑ºÏÑ± (a11y)

- Î™®Îì† Ìèº ÌïÑÎìúÏóê `<label>` Ïó∞Í≤∞ (`htmlFor`)
- ÌïÑÏàò ÌïÑÎìúÎäî `aria-required="true"`
- ÏóêÎü¨ Î©îÏãúÏßÄÎäî `aria-live="polite"` ÏòÅÏó≠Ïóê ÌëúÏãú
- Î°úÎî© ÏÉÅÌÉúÎäî `aria-busy="true"` ÏÑ§Ï†ï
- Ï†úÏ∂ú Î≤ÑÌäºÏùÄ ÎπÑÌôúÏÑ±Ìôî Ïãú `aria-disabled="true"` Î∞è ÏÑ§Î™Ö Ï∂îÍ∞Ä

---

## 12. ÌÖåÏä§Ìä∏ ÏºÄÏù¥Ïä§

### 12.1 Îã®ÏúÑ ÌÖåÏä§Ìä∏ (Reducer)

- [ ] `FETCH_USAGE_SUCCESS` Ïãú `usageInfo` ÏóÖÎç∞Ïù¥Ìä∏
- [ ] `SUBMIT_START` Ïãú `isSubmitting = true`
- [ ] `SUBMIT_ERROR` Ïãú `submitError` ÏÑ§Ï†ï, `isSubmitting = false`
- [ ] `RESET_ERROR` Ïãú ÏóêÎü¨ Ï¥àÍ∏∞Ìôî

### 12.2 ÌÜµÌï© ÌÖåÏä§Ìä∏ (Context + API)

- [ ] ÌéòÏù¥ÏßÄ ÎßàÏö¥Ìä∏ Ïãú ÏÇ¨Ïö©Îüâ ÏûêÎèô Ï°∞Ìöå
- [ ] ÏÇ¨Ïö©Îüâ Ï¥àÍ≥º Ïãú Ìèº ÎπÑÌôúÏÑ±Ìôî
- [ ] Î∂ÑÏÑù ÏöîÏ≤≠ ÏÑ±Í≥µ Ïãú ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
- [ ] API ÏóêÎü¨ Ïãú ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú Î∞è Ïû¨ÏãúÎèÑ Í∞ÄÎä•

### 12.3 E2E ÌÖåÏä§Ìä∏

- [ ] Î¨¥Î£å Ïú†Ï†Ä: 1Ìöå ÏÇ¨Ïö© ÌõÑ Pro ÏóÖÍ∑∏Î†àÏù¥Îìú Ïú†ÎèÑ
- [ ] Pro Ïú†Ï†Ä: 10Ìöå ÏÇ¨Ïö© ÌõÑ ÏÇ¨Ïö©Îüâ Ï¥àÍ≥º Î©îÏãúÏßÄ
- [ ] Íµ¨ÎèÖ ÎßåÎ£å Ïú†Ï†Ä: Ïû¨Íµ¨ÎèÖ ÏïàÎÇ¥

---

## 13. ÌååÏùº Íµ¨Ï°∞

```
src/features/analysis/
‚îú‚îÄ‚îÄ context/
‚îÇ   ‚îî‚îÄ‚îÄ analysis-new-context.tsx        # Context + Reducer + Provider
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ analysis-form.tsx               # Ìèº Ïª¥Ìè¨ÎÑåÌä∏ (react-hook-form)
‚îÇ   ‚îú‚îÄ‚îÄ usage-display.tsx               # ÏÇ¨Ïö©Îüâ ÌëúÏãú Ïª¥Ìè¨ÎÑåÌä∏
‚îÇ   ‚îú‚îÄ‚îÄ loading-overlay.tsx             # Î°úÎî© Ïò§Î≤ÑÎ†àÏù¥
‚îÇ   ‚îî‚îÄ‚îÄ error-alert.tsx                 # ÏóêÎü¨ Î©îÏãúÏßÄ
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ use-analysis-new.ts             # Context ÌõÖ Ïû¨ÎÖ∏Ï∂ú
‚îÇ   ‚îî‚îÄ‚îÄ use-analysis-form.ts            # react-hook-form ÏÑ§Ï†ï ÌõÖ
‚îî‚îÄ‚îÄ lib/
    ‚îî‚îÄ‚îÄ validation.ts                   # Ìèº Í≤ÄÏ¶ù Ïä§ÌÇ§Îßà (Zod)

src/app/analysis/new/
‚îî‚îÄ‚îÄ page.tsx                            # ÌéòÏù¥ÏßÄ ÏóîÌä∏Î¶¨ (Provider ÎûòÌïë)
```

---

## 14. Í¥ÄÎ†® Î¨∏ÏÑú

- **PRD**: `/docs/prd.md` - ÏÑπÏÖò 3.2.4 (ÏÉà Î∂ÑÏÑùÌïòÍ∏∞), 6.3 (ÏÇ¨Ï£º Î∂ÑÏÑù ÏãúÏä§ÌÖú), 6.4 (ÏÇ¨Ïö©Îüâ Í¥ÄÎ¶¨)
- **Userflow**: `/docs/userflow.md` - ÏÑπÏÖò 1.2 (Ï≤´ Î∂ÑÏÑù ÏàòÌñâ), 3 (ÏÇ¨Ï£º Î∂ÑÏÑù ÏöîÏ≤≠)
- **Database**: `/docs/database.md` - ÏÑπÏÖò 3.3 (analyses)
- **Usecase 1**: `/docs/usecases/1-signup-and-first-analysis/spec.md` - Î¨¥Î£å Ïú†Ï†Ä Ï≤´ Î∂ÑÏÑù
- **Usecase 3**: `/docs/usecases/3-analysis-request/spec.md` - Pro Ïú†Ï†Ä Î∂ÑÏÑù ÏöîÏ≤≠
- **Common Modules**: `/docs/common-modules.md` - ÏÑπÏÖò 2.5 (Ìèº Í≤ÄÏ¶ù Ïä§ÌÇ§Îßà), 1.4 (ÏÇ¨Ïö©Îüâ Í¥ÄÎ¶¨)

---

## 15. Î≥ÄÍ≤Ω Ïù¥Î†•

| Î≤ÑÏ†Ñ | ÎÇ†Ïßú | ÏûëÏÑ±Ïûê | Î≥ÄÍ≤Ω ÎÇ¥Ïö© |
|------|------|--------|----------|
| 1.0 | 2025-10-27 | Claude Code | Ï¥àÍ∏∞ ÏûëÏÑ± |

---

## 16. ÏäπÏù∏

- [ ] ÌîÑÎ°†Ìä∏ÏóîÎìú Î¶¨Îìú
- [ ] UX ÎîîÏûêÏù¥ÎÑà
- [ ] Ï†úÌíà Í¥ÄÎ¶¨Ïûê
